# 图书借阅系统完整流程图

## 一、普通用户借阅流程

### 场景1：直接借阅（有库存）

```
用户点击借阅按钮
    ↓
[前端] 发送 POST /borrow/borrowBook { book_id }
    ↓
[后端] BorrowBook 服务
    ↓
┌─────────────────────────────────────┐
│ 1. 检查读者信息                      │
│    - 读者不存在？→ 自动创建          │
│    - 读者状态异常？→ ❌ 返回错误     │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 2. 检查读者资格                      │
│    - 在黑名单？→ ❌ "您已被列入黑名单"│
│    - 有未支付罚款？→ ❌ "请先支付罚款"│
│    - 有逾期图书？→ ❌ "有图书逾期未还"│
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 3. 检查图书信息                      │
│    - 图书不存在？→ ❌ "图书不存在"   │
│    - 库存 <= 0？→ ❌ "图书库存不足"  │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 4. 检查预约状态                      │
│    - 有其他用户的可用预约？          │
│      → ❌ "该图书已被其他用户预约"   │
│    - 有当前用户的可用预约？          │
│      → 自动关联预约ID                │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 5. 检查借阅限制                      │
│    - 已达到最大借阅数量？            │
│      → ❌ "已达到最大借阅数量"       │
│    - 已借阅该书？                    │
│      → ❌ "您已借阅该书"             │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 6. 创建借阅记录                      │
│    - 状态：pending（待审批）         │
│    - 库存：不减少（待审批）          │
│    - 如果通过预约：更新预约为fulfilled│
└─────────────────────────────────────┘
    ↓
✅ 返回成功，状态为"待审批"
    ↓
[前端] 按钮变为黄色（待审批）
    ↓
等待管理员审批...
```

### 场景2：库存不足 → 预约

```
用户点击借阅按钮
    ↓
[后端] 检查库存 → 库存 <= 0
    ↓
❌ 返回错误 code: 4001, msg: "图书库存不足"
    ↓
[前端] 检测到 code: 4001
    ↓
[前端] 弹出确认对话框："库存不足，是否预约？"
    ↓
用户点击"确认预约"
    ↓
[前端] 发送 POST /reservation/create { book_id }
    ↓
[后端] CreateReservation 服务
    ↓
┌─────────────────────────────────────┐
│ 1. 检查读者资格                      │
│    - 读者状态异常？→ ❌ 错误         │
│    - 在黑名单？→ ❌ "您已被列入黑名单"│
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 2. 检查预约限制                      │
│    - 已达到最大预约数量？            │
│      → ❌ "已达到最大预约数量"       │
│    - 已预约该书？                    │
│      → ❌ "您已预约该书"             │
│    - 已借阅该书？                    │
│      → ❌ "您已借阅该书，无需预约"   │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 3. 创建预约记录                      │
│    - 状态：pending（等待库存）       │
│    - 计算队列位置                    │
└─────────────────────────────────────┘
    ↓
✅ 返回成功 + 队列位置
    ↓
[前端] 按钮变为绿色（已预约）
    ↓
等待库存补充...
```

### 场景3：预约状态变为可用 → 借阅

```
[定时任务/管理员更新库存]
    ↓
库存从 0 变为 > 0
    ↓
[后端] CheckAndNotifyAvailableReservations
    ↓
查找状态为 pending 的预约（按创建时间排序）
    ↓
找到第一个预约
    ↓
┌─────────────────────────────────────┐
│ 更新预约状态                         │
│    - 状态：pending → available       │
│    - 设置 available_date             │
│    - 设置 pickup_deadline（N天后）   │
└─────────────────────────────────────┘
    ↓
发送站内消息给预约用户
    ↓
[前端] 用户收到消息通知
    ↓
[前端] 按钮变为绿色闪烁（可借阅）
    ↓
用户点击借阅按钮
    ↓
[前端] 发送 POST /borrow/borrowBook 
       { book_id, reservation_id }
    ↓
[后端] BorrowBook 服务
    ↓
验证预约：
  - 预约存在？
  - 预约属于当前用户？
  - 预约状态为 available？
    ↓
创建借阅记录（状态：pending）
    ↓
更新预约状态为 fulfilled
    ↓
✅ 返回成功
    ↓
[前端] 按钮变为黄色（待审批）
```

### 场景4：管理员审批

```
管理员查看待审批列表
    ↓
管理员点击"批准"
    ↓
[前端] 发送 POST /borrow/approve
       { record_id, approved: true }
    ↓
[后端] ApproveBorrowRequest 服务
    ↓
┌─────────────────────────────────────┐
│ 1. 检查借阅记录                      │
│    - 记录不存在？→ ❌ 错误           │
│    - 状态不是 pending？→ ❌ 错误     │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 2. 检查库存                          │
│    - 库存 <= 0？→ ❌ "库存不足"      │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 3. 更新借阅记录                      │
│    - 状态：pending → borrowed        │
│    - 设置 approved_date              │
│    - 减少库存                        │
└─────────────────────────────────────┘
    ↓
✅ 返回成功
    ↓
[前端] 用户看到按钮变为蓝色（已借阅）
```

### 场景5：管理员拒绝

```
管理员点击"拒绝"
    ↓
[前端] 发送 POST /borrow/approve
       { record_id, approved: false, reject_reason }
    ↓
[后端] ApproveBorrowRequest 服务
    ↓
更新借阅记录：
  - 状态：pending → rejected
  - 添加拒绝原因到 remark
    ↓
✅ 返回成功
    ↓
[前端] 用户看到按钮恢复为灰色（未借阅）
```

## 二、管理员为读者借阅流程

```
管理员选择读者和图书
    ↓
[前端] 发送 POST /borrow/borrowBook
       { reader_id, book_id }
    ↓
[后端] BorrowBook 服务
    ↓
检查流程（同普通用户，但跳过部分检查）
    ↓
判断：userID != operatorID（管理员操作）
    ↓
┌─────────────────────────────────────┐
│ 创建借阅记录                         │
│    - 状态：borrowed（直接借出）      │
│    - 立即减少库存                    │
│    - 不需要审批                      │
└─────────────────────────────────────┘
    ↓
✅ 返回成功
```

## 三、取消操作流程

### 取消预约

```
用户点击绿色预约按钮
    ↓
[前端] 弹出确认："是否取消预约？"
    ↓
用户确认
    ↓
[前端] 发送 DELETE /reservation/cancel/:id
    ↓
[后端] CancelReservation 服务
    ↓
┌─────────────────────────────────────┐
│ 1. 检查预约记录                      │
│    - 记录不存在？→ ❌ 错误           │
│    - 不属于当前用户？→ ❌ 错误       │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 2. 更新预约状态                      │
│    - 状态：pending/available → cancelled│
│    - 设置 fulfilled_date             │
└─────────────────────────────────────┘
    ↓
✅ 返回成功
    ↓
[前端] 按钮恢复为灰色
```

### 取消借阅申请

```
用户点击黄色待审批按钮
    ↓
[前端] 弹出确认："是否取消借阅申请？"
    ↓
用户确认
    ↓
[前端] 发送 POST /borrow/cancelBorrowRequest
       { record_id }
    ↓
[后端] CancelBorrowRequest 服务
    ↓
┌─────────────────────────────────────┐
│ 1. 检查借阅记录                      │
│    - 记录不存在？→ ❌ 错误           │
│    - 不属于当前用户？→ ❌ 错误       │
│    - 状态不是 pending？→ ❌ 错误     │
└─────────────────────────────────────┘
    ↓
┌─────────────────────────────────────┐
│ 2. 更新借阅记录                      │
│    - 状态：pending → rejected        │
│    - 添加备注："用户主动取消"        │
└─────────────────────────────────────┘
    ↓
✅ 返回成功
    ↓
[前端] 按钮恢复为灰色
```

## 四、预约过期处理

```
[定时任务] 每天检查预约
    ↓
查找状态为 available 的预约
    ↓
检查 pickup_deadline < 当前时间
    ↓
找到过期预约
    ↓
┌─────────────────────────────────────┐
│ 更新预约状态                         │
│    - 状态：available → expired       │
│    - 设置 fulfilled_date             │
└─────────────────────────────────────┘
    ↓
预约失效，其他用户可以借阅
```

## 五、状态流转图

### 借阅记录状态流转

```
未借阅（无记录）
    ↓
[用户点击借阅]
    ↓
待审批（pending） ←→ [用户取消] → 已拒绝（rejected）
    ↓
[管理员批准]              [管理员拒绝] → 已拒绝（rejected）
    ↓
已借阅（borrowed）
    ↓
[到期未还] → 已逾期（overdue）
    ↓
[用户还书] → 已归还（returned）
```

### 预约状态流转

```
未预约（无记录）
    ↓
[用户预约]
    ↓
等待中（pending）
    ↓
[库存补充] → 可借阅（available）
    ↓
[用户借阅] → 已完成（fulfilled）
    ↓
[用户取消] → 已取消（cancelled）
    ↓
[超过取书期限] → 已过期（expired）
```

## 六、按钮状态说明

| 按钮颜色 | 状态 | 说明 | 点击操作 |
|---------|------|------|---------|
| 灰色 | 未借阅 | 可以借阅 | 点击借阅 |
| 绿色 | 已预约（pending） | 等待库存 | 点击取消预约 |
| 绿色闪烁 | 已预约（available） | 可借阅 | 点击借阅 |
| 黄色 | 待审批（pending） | 等待管理员审批 | 点击取消申请 |
| 蓝色 | 已借阅（borrowed） | 已借阅 | 点击还书 |

## 七、错误情况汇总

### 读者相关错误
- ❌ "读者不存在" → 自动创建
- ❌ "读者状态异常，无法借书"
- ❌ "您已被列入黑名单，无法借书"
- ❌ "您有未支付的罚款，请先支付后再借书"
- ❌ "您有图书逾期未还，超过N天将禁止借书"

### 图书相关错误
- ❌ "图书不存在"
- ❌ "图书库存不足" → 建议预约（code: 4001）
- ❌ "该图书已被其他用户预约，请等待预约失效后再试"

### 借阅限制错误
- ❌ "已达到最大借阅数量"
- ❌ "您已借阅该书"
- ❌ "已达到最大预约数量"
- ❌ "您已预约该书"

### 预约相关错误
- ❌ "预约记录不存在"
- ❌ "预约信息不匹配"
- ❌ "预约状态异常"

## 八、关键业务规则

1. **库存管理**
   - 普通用户借阅：待审批时不减库存，批准后才减库存
   - 管理员借阅：立即减库存
   - 还书时：立即增加库存

2. **预约优先级**
   - 有可用预约时，只有预约用户可以借阅
   - 预约过期后，其他用户可以借阅
   - 预约用户可以直接借阅（自动关联预约）

3. **审批流程**
   - 普通用户借阅需要管理员审批
   - 管理员为读者借阅不需要审批
   - 待审批状态可以取消

4. **预约通知**
   - 库存补充时，自动通知第一个预约用户
   - 通知后设置取书期限
   - 超过期限自动失效

5. **并发控制**
   - 使用数据库事务保证数据一致性
   - 库存检查在事务中进行
   - 预约状态检查防止重复借阅

